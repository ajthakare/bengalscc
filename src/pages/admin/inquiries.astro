---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';

// Check authentication
const cookieHeader = Astro.request.headers.get('cookie');
let authenticated = false;
let username = '';
let userRole = 'admin';

if (cookieHeader) {
  try {
    const response = await fetch(
      `${Astro.url.origin}/.netlify/functions/auth-check`,
      {
        headers: {
          cookie: cookieHeader,
        },
      }
    );
    const data = await response.json();
    authenticated = data.authenticated;
    username = data.user?.firstName || data.user?.username || '';
    userRole = data.user?.role_auth || data.user?.role || 'admin';
  } catch (error) {
    authenticated = false;
  }
}

// Redirect to login if not authenticated
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Website Inquiries - GSCC Admin" username={username} userRole={userRole} activePage="inquiries">
  <div class="dashboard">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Website Inquiries</h1>
      <p class="page-description">View and manage contact form submissions from the website</p>
    </div>

    <!-- Search Bar and Bulk Actions -->
    <div class="toolbar">
      <div class="search-container">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="9" r="7"/>
          <path d="M14 14l5 5"/>
        </svg>
        <input
          type="text"
          id="search-input"
          placeholder="Search by name, email, or message..."
          class="search-input"
        />
      </div>
      <button id="refresh-button" class="btn-secondary">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 4v6h6M19 16v-6h-6"/>
          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m18 0l-4.64 4.36A9 9 0 0 1 .51 11"/>
        </svg>
        Refresh
      </button>
      <div id="bulk-actions" class="bulk-actions" style="display: none;">
        <span id="selected-count" class="selected-count">0 selected</span>
        <button id="delete-selected-btn" class="btn-danger-outline">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 4h12M5 4V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1m2 0v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4h10z"/>
          </svg>
          Delete Selected
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="stats-grid" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Total Submissions</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">New Messages</div>
        <div class="stat-value stat-new" id="stat-new">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Read Messages</div>
        <div class="stat-value" id="stat-read">0</div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="state-container">
      <div class="spinner"></div>
      <p class="state-text">Loading submissions...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="state-container" style="display: none;">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p class="state-title">Error loading submissions</p>
      <p class="state-text" id="error-text"></p>
      <button id="retry-button" class="btn-secondary">Try Again</button>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="state-container" style="display: none;">
      <div class="empty-icon">üì¨</div>
      <p class="state-title">No submissions yet</p>
      <p class="state-text">Contact form submissions will appear here</p>
    </div>

    <!-- Submissions Table -->
    <div id="submissions-container" style="display: none;">
      <div class="table-container">
        <table class="submissions-table">
          <thead>
            <tr>
              <th class="th-checkbox">
                <input type="checkbox" id="select-all-checkbox" class="checkbox" />
              </th>
              <th>Status</th>
              <th>Date</th>
              <th>Name</th>
              <th>Email</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="submissions-tbody">
            <!-- Submissions will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Submission Detail Modal -->
    <div id="submission-modal" class="modal">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h2 class="modal-title">Submission Details</h2>
            <p class="modal-subtitle" id="modal-date"></p>
          </div>
          <button id="close-modal" class="modal-close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div id="modal-body" class="modal-body">
          <!-- Content will be inserted here -->
        </div>

        <div class="modal-footer">
          <button id="delete-submission" class="btn-danger">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h14M8 6V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2m3 0v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h10z"/>
            </svg>
            Delete Submission
          </button>
          <button id="close-modal-button" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  interface Submission {
    id: string;
    number: number;
    name: string;
    email: string;
    phone: string;
    message: string;
    createdAt: string;
    formName: string;
    read?: boolean;
  }

  interface SubmissionMetadata {
    id: string;
    read: boolean;
    archived: boolean;
  }

  let allSubmissions: Submission[] = [];
  let filteredSubmissions: Submission[] = [];
  let submissionMetadata: Map<string, SubmissionMetadata> = new Map();
  let currentSubmission: Submission | null = null;

  const loadingState = document.getElementById('loading-state')!;
  const errorState = document.getElementById('error-state')!;
  const errorText = document.getElementById('error-text')!;
  const emptyState = document.getElementById('empty-state')!;
  const submissionsContainer = document.getElementById('submissions-container')!;
  const submissionsTbody = document.getElementById('submissions-tbody')!;
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const refreshButton = document.getElementById('refresh-button')!;
  const retryButton = document.getElementById('retry-button')!;
  const modal = document.getElementById('submission-modal')!;
  const modalBody = document.getElementById('modal-body')!;
  const modalDate = document.getElementById('modal-date')!;
  const closeModalButton = document.getElementById('close-modal')!;
  const closeModalButton2 = document.getElementById('close-modal-button')!;
  const deleteButton = document.getElementById('delete-submission')!;
  const statsGrid = document.getElementById('stats-grid')!;

  // Ensure modal is hidden on page load
  modal.classList.remove('modal-open');

  async function loadSubmissions() {
    try {
      loadingState.style.display = 'flex';
      errorState.style.display = 'none';
      emptyState.style.display = 'none';
      submissionsContainer.style.display = 'none';
      statsGrid.style.display = 'none';

      const response = await fetch('/.netlify/functions/get-submissions');
      if (!response.ok) throw new Error('Failed to fetch submissions');

      const data = await response.json();
      allSubmissions = data.submissions || [];

      // Load metadata (read status)
      await loadMetadata();

      // Merge metadata with submissions
      allSubmissions = allSubmissions.map(sub => ({
        ...sub,
        read: submissionMetadata.get(sub.id)?.read || false
      }));

      filteredSubmissions = [...allSubmissions];

      loadingState.style.display = 'none';

      if (allSubmissions.length === 0) {
        emptyState.style.display = 'flex';
      } else {
        updateStats();
        renderSubmissions();
        submissionsContainer.style.display = 'block';
        statsGrid.style.display = 'grid';
      }
    } catch (error) {
      loadingState.style.display = 'none';
      errorState.style.display = 'flex';
      errorText.textContent = error instanceof Error ? error.message : 'Unknown error';
    }
  }

  async function loadMetadata() {
    try {
      const response = await fetch('/.netlify/functions/get-submission-metadata');
      if (response.ok) {
        const metadataMap = await response.json();
        submissionMetadata.clear();

        // Convert object to Map
        Object.keys(metadataMap).forEach((id) => {
          submissionMetadata.set(id, metadataMap[id]);
        });
      }
    } catch (error) {
      console.error('Failed to load metadata:', error);
      submissionMetadata.clear();
    }
  }

  function updateStats() {
    const total = allSubmissions.length;
    const newCount = allSubmissions.filter(s => !s.read).length;
    const readCount = allSubmissions.filter(s => s.read).length;

    document.getElementById('stat-total')!.textContent = total.toString();
    document.getElementById('stat-new')!.textContent = newCount.toString();
    document.getElementById('stat-read')!.textContent = readCount.toString();
  }

  function renderSubmissions() {
    submissionsTbody.innerHTML = '';

    filteredSubmissions.forEach((submission) => {
      const row = document.createElement('tr');
      row.className = submission.read ? 'row-read' : 'row-unread';
      row.onclick = () => showSubmissionDetail(submission);

      const date = new Date(submission.createdAt);
      const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

      row.innerHTML = `
        <td class="td-checkbox" onclick="event.stopPropagation();">
          <input type="checkbox" class="checkbox row-checkbox" data-id="${submission.id}" />
        </td>
        <td>
          ${!submission.read ? '<span class="badge-new">New</span>' : '<span class="badge-read">Read</span>'}
        </td>
        <td class="col-date">
          <div class="date-primary">${formattedDate}</div>
          <div class="date-secondary">${formattedTime}</div>
        </td>
        <td class="col-name">${submission.name}</td>
        <td class="col-email">${submission.email}</td>
        <td onclick="event.stopPropagation();">
          <button class="btn-view" onclick="showSubmissionDetail(${JSON.stringify(submission).replace(/"/g, '&quot;')})">
            View
          </button>
        </td>
      `;

      submissionsTbody.appendChild(row);
    });
  }

  async function showSubmissionDetail(submission: Submission) {
    currentSubmission = submission;

    const date = new Date(submission.createdAt);
    const formattedDateTime = date.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    modalDate.textContent = formattedDateTime;

    modalBody.innerHTML = `
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 13.5V13a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v.5"/>
              <circle cx="8" cy="6" r="3"/>
            </svg>
            Name
          </div>
          <div class="detail-value">${submission.name}</div>
        </div>

        <div class="detail-item">
          <div class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 4h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1z"/>
              <path d="M15 5l-7 5-7-5"/>
            </svg>
            Email
          </div>
          <div class="detail-value">
            <a href="mailto:${submission.email}" class="detail-link">
              ${submission.email}
            </a>
          </div>
        </div>

        ${submission.phone ? `
          <div class="detail-item">
            <div class="detail-label">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 10.5v2a1.5 1.5 0 0 1-1.5 1.5A12.5 12.5 0 0 1 2 3.5 1.5 1.5 0 0 1 3.5 2h2a1.5 1.5 0 0 1 1.5 1.5 9 9 0 0 0 .5 2.5 1.5 1.5 0 0 1-.3 1.6l-.9.9a9 9 0 0 0 5 5l.9-.9a1.5 1.5 0 0 1 1.6-.3 9 9 0 0 0 2.5.5 1.5 1.5 0 0 1 1.5 1.5z"/>
              </svg>
              Phone
            </div>
            <div class="detail-value">
              <a href="tel:${submission.phone}" class="detail-link">
                ${submission.phone}
              </a>
            </div>
          </div>
        ` : ''}

        <div class="detail-item detail-full">
          <div class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"/>
              <path d="M5 6h6M5 9h6M5 12h3"/>
            </svg>
            Message
          </div>
          <div class="detail-value detail-message">${submission.message}</div>
        </div>
      </div>
    `;

    modal.classList.add('modal-open');
    document.body.style.overflow = 'hidden';

    // Mark as read
    if (!submission.read) {
      await markAsRead(submission.id);

      // Update the submission in allSubmissions array
      const index = allSubmissions.findIndex(s => s.id === submission.id);
      if (index !== -1) {
        allSubmissions[index].read = true;
      }
      submission.read = true;

      updateStats();
      renderSubmissions();
    }
  }

  async function markAsRead(submissionId: string) {
    try {
      const response = await fetch('/.netlify/functions/update-submission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: submissionId, action: 'mark-read' }),
      });

      if (response.ok) {
        // Update local metadata
        const data = await response.json();
        if (data.metadata) {
          submissionMetadata.set(submissionId, data.metadata);
        }
      }
    } catch (error) {
      console.error('Failed to mark as read:', error);
    }
  }

  function closeModal(e?: Event) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    modal.classList.remove('modal-open');
    document.body.style.overflow = '';
    currentSubmission = null;
  }

  async function deleteSubmission() {
    if (!currentSubmission) return;

    if (!confirm('Are you sure you want to delete this submission? This cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch('/.netlify/functions/update-submission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentSubmission.id, action: 'delete' }),
      });

      if (!response.ok) throw new Error('Failed to delete submission');

      closeModal();
      await loadSubmissions();
    } catch (error) {
      alert('Failed to delete submission: ' + (error instanceof Error ? error.message : 'Unknown error'));
    }
  }

  function filterSubmissions() {
    const query = searchInput.value.toLowerCase();

    if (!query) {
      filteredSubmissions = [...allSubmissions];
    } else {
      filteredSubmissions = allSubmissions.filter((sub) =>
        sub.name.toLowerCase().includes(query) ||
        sub.email.toLowerCase().includes(query) ||
        sub.message.toLowerCase().includes(query)
      );
    }

    renderSubmissions();
  }

  // Bulk selection variables
  let selectedIds = new Set<string>();
  const selectAllCheckbox = document.getElementById('select-all-checkbox') as HTMLInputElement;
  const bulkActions = document.getElementById('bulk-actions')!;
  const selectedCount = document.getElementById('selected-count')!;
  const deleteSelectedBtn = document.getElementById('delete-selected-btn')!;

  function updateBulkActions() {
    const count = selectedIds.size;
    if (count > 0) {
      bulkActions.style.display = 'flex';
      selectedCount.textContent = `${count} selected`;
    } else {
      bulkActions.style.display = 'none';
    }

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    selectAllCheckbox.checked = checkedCount > 0 && checkedCount === allCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
  }

  function handleCheckboxChange(e: Event) {
    const checkbox = e.target as HTMLInputElement;
    const id = checkbox.dataset.id!;

    if (checkbox.checked) {
      selectedIds.add(id);
    } else {
      selectedIds.delete(id);
    }

    updateBulkActions();
  }

  function handleSelectAll(e: Event) {
    const checkbox = e.target as HTMLInputElement;
    const rowCheckboxes = document.querySelectorAll('.row-checkbox') as NodeListOf<HTMLInputElement>;

    rowCheckboxes.forEach((cb) => {
      cb.checked = checkbox.checked;
      const id = cb.dataset.id!;
      if (checkbox.checked) {
        selectedIds.add(id);
      } else {
        selectedIds.delete(id);
      }
    });

    updateBulkActions();
  }

  async function deleteSelected() {
    if (selectedIds.size === 0) return;

    const count = selectedIds.size;
    if (!confirm(`Are you sure you want to delete ${count} submission${count > 1 ? 's' : ''}? This cannot be undone.`)) {
      return;
    }

    const idsToDelete = Array.from(selectedIds);
    let successCount = 0;
    let failCount = 0;

    // Delete each submission
    for (const id of idsToDelete) {
      try {
        const response = await fetch('/.netlify/functions/update-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'delete' }),
        });

        if (response.ok) {
          successCount++;
        } else {
          failCount++;
        }
      } catch (error) {
        failCount++;
      }
    }

    // Clear selection
    selectedIds.clear();
    updateBulkActions();

    // Reload submissions
    await loadSubmissions();

    // Show result
    if (failCount > 0) {
      alert(`Deleted ${successCount} submission(s). ${failCount} failed.`);
    }
  }

  // Setup checkbox listeners after rendering
  function setupCheckboxListeners() {
    document.querySelectorAll('.row-checkbox').forEach((checkbox) => {
      checkbox.addEventListener('change', handleCheckboxChange);
    });
  }

  // Event listeners
  searchInput.addEventListener('input', filterSubmissions);
  refreshButton.addEventListener('click', loadSubmissions);
  retryButton.addEventListener('click', loadSubmissions);
  closeModalButton.addEventListener('click', (e) => closeModal(e));
  closeModalButton2.addEventListener('click', (e) => closeModal(e));
  deleteButton.addEventListener('click', deleteSubmission);
  selectAllCheckbox.addEventListener('change', handleSelectAll);
  deleteSelectedBtn.addEventListener('click', deleteSelected);

  // Update renderSubmissions to setup checkboxes
  const originalRenderSubmissions = renderSubmissions;
  renderSubmissions = function() {
    selectedIds.clear();
    originalRenderSubmissions();
    setupCheckboxListeners();
    updateBulkActions();
  };

  // Close modal on overlay click
  modal.addEventListener('click', (e) => {
    if (e.target === modal || (e.target as HTMLElement).classList.contains('modal-overlay')) {
      closeModal(e);
    }
  });

  // Close modal on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('modal-open')) {
      closeModal(e);
    }
  });

  // Make function globally available
  (window as any).showSubmissionDetail = showSubmissionDetail;

  // Load submissions on page load
  loadSubmissions();
</script>

<style is:global>
  .dashboard {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Page Header */
  .page-header {
    margin-bottom: 32px;
  }

  /* Note: .page-title and .page-description styles are now in theme file */

  /* Buttons */
  .btn-primary {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary:hover {
    background: #ea580c;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
  }

  .btn-secondary {
    padding: 12px 24px;
    background: white;
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    background: var(--color-bg-card);
    border-color: var(--color-border-strong);
  }

  .btn-danger {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-danger-outline {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: white;
    color: #ef4444;
    border: 2px solid #ef4444;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-danger-outline:hover {
    background: #fef2f2;
    border-color: #dc2626;
    color: #dc2626;
  }

  /* Bulk Actions */
  .bulk-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 8px;
  }

  .selected-count {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text-heading);
  }

  /* Checkboxes */
  .checkbox {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    accent-color: var(--color-primary);
  }

  .checkbox:hover {
    border-color: var(--color-primary);
  }

  .th-checkbox,
  .td-checkbox {
    width: 40px;
    text-align: center;
  }

  .td-checkbox {
    padding: 16px 8px;
  }

  .btn-view {
    padding: 8px 20px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .btn-view:hover {
    background: #ea580c;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);
  }

  .btn-view:active {
    transform: translateY(0);
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  /* Search */
  .search-container {
    position: relative;
    flex: 1;
    min-width: 300px;
  }

  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 14px 16px 14px 48px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    font-size: 14px;
    color: var(--color-text-body);
    transition: all 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
  }

  .search-input::placeholder {
    color: #94a3b8;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 20px;
  }

  .stat-label {
    font-size: 13px;
    color: var(--color-text-muted);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--color-text-heading);
  }

  .stat-new {
    color: var(--color-primary);
  }

  /* States */
  .state-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-bg-card);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .state-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--color-text-heading);
    margin-bottom: 8px;
  }

  .state-text {
    font-size: 14px;
    color: var(--color-text-muted);
    margin-bottom: 24px;
  }

  .empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
  }

  .error-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  /* Table */
  .table-container {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
  }

  .submissions-table {
    width: 100%;
    border-collapse: collapse;
  }

  .submissions-table thead {
    background: var(--color-bg-card);
    border-bottom: 2px solid var(--color-border);
  }

  .submissions-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .submissions-table td {
    padding: 16px;
    border-bottom: 1px solid var(--color-border);
    font-size: 14px;
    color: var(--color-text-muted);
  }

  .submissions-table tbody tr {
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid var(--color-border);
  }

  .submissions-table tbody tr:hover {
    background: var(--color-bg-card);
  }

  .submissions-table tbody tr:last-child td {
    border-bottom: none;
  }

  .submissions-table tbody tr:last-child {
    border-bottom: none;
  }

  .row-unread {
    background: var(--color-bg-hero);
  }

  .row-unread:hover {
    background: var(--color-bg-hero-dark) !important;
  }

  .col-name {
    font-weight: 600;
    color: var(--color-text-heading);
  }

  .col-email {
    color: var(--color-text-muted);
  }

  .col-date {
    min-width: 100px;
  }

  .date-primary {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 2px;
  }

  .date-secondary {
    font-size: 12px;
    color: #94a3b8;
  }

  /* Badges */
  .badge-new {
    display: inline-block;
    padding: 4px 12px;
    background: var(--color-bg-hero);
    color: var(--color-primary);
    font-size: 12px;
    font-weight: 600;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-read {
    display: inline-block;
    padding: 4px 12px;
    background: #f1f5f9;
    color: #94a3b8;
    font-size: 12px;
    font-weight: 600;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal.modal-open {
    display: flex;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    position: relative;
    width: 100%;
    max-width: 700px;
    max-height: 90vh;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s;
    display: flex;
    flex-direction: column;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 24px 24px 20px;
    border-bottom: 1px solid var(--color-border);
  }

  .modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--color-text-heading);
    margin-bottom: 4px;
  }

  .modal-subtitle {
    font-size: 13px;
    color: var(--color-text-muted);
  }

  .modal-close {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: var(--color-bg-card);
    color: var(--color-text-heading);
  }

  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .detail-grid {
    display: grid;
    gap: 20px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .detail-full {
    grid-column: 1 / -1;
  }

  .detail-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .detail-value {
    font-size: 15px;
    color: var(--color-text-heading);
    line-height: 1.6;
  }

  .detail-message {
    white-space: pre-wrap;
    background: var(--color-bg-card);
    padding: 16px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
  }

  .detail-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .detail-link:hover {
    color: #ea580c;
    text-decoration: underline;
  }

  .modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid var(--color-border);
    background: var(--color-bg-card);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      margin-bottom: 24px;
    }

    .table-container {
      overflow-x: auto;
    }

    .submissions-table {
      min-width: 800px;
    }
  }
</style>
