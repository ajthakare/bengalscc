---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';

// Check authentication
const cookieHeader = Astro.request.headers.get('cookie');
let authenticated = false;
let username = '';
let userRole = 'admin';

if (cookieHeader) {
  try {
    const response = await fetch(
      `${Astro.url.origin}/.netlify/functions/auth-check`,
      {
        headers: {
          cookie: cookieHeader,
        },
      }
    );
    const data = await response.json();
    authenticated = data.authenticated;
    username = data.user?.firstName || data.user?.username || '';
    userRole = data.user?.role_auth || data.user?.role || 'admin';
  } catch (error) {
    authenticated = false;
  }
}

// Redirect to login if not authenticated
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Player Management - GSCC Admin" username={username} userRole={userRole} activePage="players">
  <div class="players-page">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Player Management</h1>
      <p class="page-description">Manage the global player pool</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="stats-grid" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Total Players</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Players</div>
        <div class="stat-value stat-success" id="stat-active">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Inactive Players</div>
        <div class="stat-value stat-muted" id="stat-inactive">0</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-container">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="9" r="7"/>
          <path d="M14 14l5 5"/>
        </svg>
        <input
          type="text"
          id="search-input"
          placeholder="Search by name, email, or USAC ID..."
          class="search-input"
        />
      </div>
      <select id="status-filter" class="filter-select">
        <option value="">All Status</option>
        <option value="active" selected>Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select id="role-filter" class="filter-select">
        <option value="">All Roles</option>
        <option value="Batsman">Batsman</option>
        <option value="Bowler">Bowler</option>
        <option value="All-rounder">All-rounder</option>
        <option value="Wicket-keeper">Wicket-keeper</option>
      </select>
      <button id="add-player-btn" class="btn-primary">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="10" y1="5" x2="10" y2="15"/>
          <line x1="5" y1="10" x2="15" y2="10"/>
        </svg>
        Add Player
      </button>
      <a href="/admin/players/import" class="btn-secondary">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 17v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2M7 9l5 5m0 0l5-5m-5 5V3"/>
        </svg>
        Import Players
      </a>
      <div id="bulk-actions" class="bulk-actions" style="display: none;">
        <span id="selected-count" class="selected-count">0 selected</span>
        <button id="change-status-btn" class="btn-secondary">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 8h12M8 2v12"/>
          </svg>
          Change Status
        </button>
        <button id="delete-selected-btn" class="btn-danger-outline">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 4h12M5 4V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1m2 0v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4h10z"/>
          </svg>
          Delete Selected
        </button>
        <button id="export-selected-btn" class="btn-secondary">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 10v3a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-3M8 2v8m0 0L5 7m3 3l3-3"/>
          </svg>
          Export
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="state-container">
      <div class="spinner"></div>
      <p class="state-text">Loading players...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="alert alert-error" style="display: none;">
      <div>
        <p class="alert-title">Error loading players</p>
        <p id="error-text"></p>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="state-container" style="display: none;">
      <div class="empty-icon">ðŸ‘¥</div>
      <p class="state-title">No players found</p>
      <p class="state-text">Add your first player to get started</p>
      <button class="btn-primary" onclick="document.getElementById('add-player-btn').click()">
        Add Player
      </button>
    </div>

    <!-- Players Table -->
    <div id="table-container" class="table-container" style="display: none;">
      <table class="data-table">
        <thead>
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" id="select-all" />
            </th>
            <th>Name</th>
            <th>Email</th>
            <th>USAC ID</th>
            <th>Role</th>
            <th>Status</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="players-tbody">
          <!-- Players will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Player Modal -->
  <div id="player-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" class="modal-title">Add New Player</h2>
        <button class="modal-close" onclick="closePlayerModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form id="player-form" class="form">
        <input type="hidden" id="player-id" name="id" />

        <div class="form-grid">
          <div class="form-group">
            <label for="first-name" class="form-label">First Name*</label>
            <input
              type="text"
              id="first-name"
              name="firstName"
              required
              minlength="1"
              maxlength="100"
              class="form-input"
              placeholder="e.g., John"
            />
          </div>
          <div class="form-group">
            <label for="last-name" class="form-label">Last Name*</label>
            <input
              type="text"
              id="last-name"
              name="lastName"
              required
              minlength="1"
              maxlength="100"
              class="form-input"
              placeholder="e.g., Doe"
            />
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="email" class="form-label">Email (Optional)</label>
            <input
              type="email"
              id="email"
              name="email"
              maxlength="255"
              class="form-input"
              placeholder="e.g., john.doe@example.com"
            />
          </div>
          <div class="form-group">
            <label for="phone" class="form-label">Phone (Optional)</label>
            <div class="phone-input-container">
              <select id="phone-country" class="phone-country-select">
                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
                <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
                <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
              </select>
              <input
                type="tel"
                id="phone-number"
                class="phone-number-input"
                placeholder="1234567890"
                pattern="[0-9]{7,15}"
              />
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="usac-id" class="form-label">USAC ID (Optional)</label>
            <input
              type="text"
              id="usac-id"
              name="usacId"
              maxlength="50"
              class="form-input"
              placeholder="e.g., USAC12345"
            />
          </div>
          <div class="form-group">
            <label for="role" class="form-label">Role (Optional)</label>
            <select id="role" name="role" class="form-input">
              <option value="">Select role...</option>
              <option value="Batsman">Batsman</option>
              <option value="Bowler">Bowler</option>
              <option value="All-rounder">All-rounder</option>
              <option value="Wicket-keeper">Wicket-keeper</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="is-active" name="isActive" checked />
            <span>Active Player</span>
          </label>
        </div>

        <div id="form-error" class="alert alert-error" style="display: none;">
          <span id="form-error-text"></span>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closePlayerModal()">Cancel</button>
          <button type="submit" id="submit-btn" class="btn-primary">Add Player</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<style>
  .players-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .toolbar {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-container {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
    cursor: pointer;
  }

  .bulk-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    padding: 0.5rem 1rem;
    background: #f9fafb;
    border-radius: 8px;
  }

  .selected-count {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .status-badge {
    display: inline-flex;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-inactive {
    background: #f3f4f6;
    color: #6b7280;
  }

  .role-badge {
    padding: 0.25rem 0.75rem;
    background: #ede9fe;
    color: #5b21b6;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .btn-icon {
    padding: 0.5rem;
    border: none;
    background: none;
    cursor: pointer;
    color: #6b7280;
    border-radius: 6px;
  }

  .btn-icon:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-danger-icon {
    color: #dc2626;
  }

  .btn-danger-icon:hover {
    background: #fee2e2;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .phone-input-container {
    display: flex;
    gap: 8px;
  }

  .phone-country-select {
    width: 110px;
    padding: 10px 8px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
  }

  .phone-number-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 14px;
  }

  .phone-country-select:focus,
  .phone-number-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
  }
</style>

<script>
  let players = [];
  let filteredPlayers = [];
  let selectedPlayerIds = new Set();
  let editingPlayerId = null;

  // DOM elements
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const errorText = document.getElementById('error-text');
  const emptyState = document.getElementById('empty-state');
  const tableContainer = document.getElementById('table-container');
  const playersTbody = document.getElementById('players-tbody');
  const statsGrid = document.getElementById('stats-grid');
  const playerModal = document.getElementById('player-modal');
  const playerForm = document.getElementById('player-form');
  const formError = document.getElementById('form-error');
  const formErrorText = document.getElementById('form-error-text');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  const selectAllCheckbox = document.getElementById('select-all');

  // Filters
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const roleFilter = document.getElementById('role-filter');

  // Load players on page load
  loadPlayers();

  // Add event listeners for filters
  searchInput.addEventListener('input', debounce(applyFilters, 300));
  statusFilter.addEventListener('change', loadPlayers); // Reload from backend when status changes
  roleFilter.addEventListener('change', loadPlayers); // Reload from backend when role changes

  // Select all checkbox
  selectAllCheckbox.addEventListener('change', (e) => {
    if (e.target.checked) {
      filteredPlayers.forEach((p) => selectedPlayerIds.add(p.id));
    } else {
      selectedPlayerIds.clear();
    }
    renderPlayers();
    updateBulkActions();
  });

  // Change status
  document.getElementById('change-status-btn').addEventListener('click', async () => {
    if (selectedPlayerIds.size === 0) return;

    const selectedPlayers = players.filter((p) => selectedPlayerIds.has(p.id));
    const hasActive = selectedPlayers.some((p) => p.isActive);
    const hasInactive = selectedPlayers.some((p) => !p.isActive);

    let action;
    if (hasActive && hasInactive) {
      // Mixed status - ask user
      action = confirm(`Set ${selectedPlayerIds.size} player(s) to active?\nOK = Active, Cancel = Inactive`)
        ? 'activate'
        : 'deactivate';
    } else if (hasActive) {
      // All active - offer to deactivate
      if (!confirm(`Mark ${selectedPlayerIds.size} player(s) as inactive?`)) return;
      action = 'deactivate';
    } else {
      // All inactive - offer to activate
      if (!confirm(`Mark ${selectedPlayerIds.size} player(s) as active?`)) return;
      action = 'activate';
    }

    try {
      const isActive = action === 'activate';
      const updatePromises = Array.from(selectedPlayerIds).map((playerId) => {
        const player = players.find((p) => p.id === playerId);
        return fetch('/.netlify/functions/players-update', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...player, id: playerId, isActive }),
        });
      });

      await Promise.all(updatePromises);
      const statusText = isActive ? 'activated' : 'deactivated';
      toast.success(`Successfully ${statusText} ${selectedPlayerIds.size} player(s)`);
      selectedPlayerIds.clear();
      await loadPlayers();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });

  // Bulk delete
  document.getElementById('delete-selected-btn').addEventListener('click', async () => {
    if (selectedPlayerIds.size === 0) return;

    if (!confirm(`Delete ${selectedPlayerIds.size} player(s)? They will be marked as inactive.`)) {
      return;
    }

    try {
      const response = await fetch('/.netlify/functions/players-delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: Array.from(selectedPlayerIds) }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete players');
      }

      toast.success(`Successfully deleted ${selectedPlayerIds.size} player(s)`);
      selectedPlayerIds.clear();
      await loadPlayers();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });

  // Export selected or all
  document.getElementById('export-selected-btn').addEventListener('click', async () => {
    try {
      const status = statusFilter.value;
      const role = roleFilter.value;
      const params = new URLSearchParams();
      if (status) params.append('status', status);
      if (role) params.append('role', role);

      const response = await fetch(`/.netlify/functions/players-export?${params}`);
      if (!response.ok) throw new Error('Failed to export players');

      const blob = await response.blob();
      const contentDisposition = response.headers.get('Content-Disposition');
      const filename = contentDisposition
        ? contentDisposition.split('filename=')[1]?.replace(/"/g, '')
        : 'players-export.csv';

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      toast.success('Players exported successfully');
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });

  async function loadPlayers() {
    try {
      loadingState.style.display = 'flex';
      errorState.style.display = 'none';
      emptyState.style.display = 'none';
      tableContainer.style.display = 'none';
      statsGrid.style.display = 'none';

      const status = statusFilter.value;
      const role = roleFilter.value;
      const params = new URLSearchParams();
      if (status) params.append('status', status);
      if (role) params.append('role', role);

      const response = await fetch(`/.netlify/functions/players-list?${params}`);
      if (!response.ok) throw new Error('Failed to load players');

      players = await response.json();
      applyFilters();

      loadingState.style.display = 'none';
      if (players.length === 0) {
        emptyState.style.display = 'flex';
      } else {
        updateStats();
        statsGrid.style.display = 'grid';
        tableContainer.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading players:', error);
      loadingState.style.display = 'none';
      errorState.style.display = 'flex';
      errorText.textContent = error.message;
    }
  }

  function applyFilters() {
    const search = searchInput.value.toLowerCase();
    const status = statusFilter.value;
    const role = roleFilter.value;

    filteredPlayers = players.filter((player) => {
      const matchesSearch =
        !search ||
        player.firstName.toLowerCase().includes(search) ||
        player.lastName.toLowerCase().includes(search) ||
        (player.email && player.email.toLowerCase().includes(search)) ||
        (player.usacId && player.usacId.toLowerCase().includes(search)) ||
        `${player.firstName} ${player.lastName}`.toLowerCase().includes(search);

      const matchesStatus =
        !status ||
        (status === 'active' && player.isActive) ||
        (status === 'inactive' && !player.isActive);

      const matchesRole =
        !role ||
        player.role === role;

      return matchesSearch && matchesStatus && matchesRole;
    });

    renderPlayers();
    updateBulkActions();
  }

  function updateStats() {
    const total = players.length;
    const active = players.filter((p) => p.isActive).length;
    const inactive = total - active;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-active').textContent = active;
    document.getElementById('stat-inactive').textContent = inactive;
  }

  function renderPlayers() {
    if (filteredPlayers.length === 0) {
      playersTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No players found</td></tr>';
      return;
    }

    playersTbody.innerHTML = filteredPlayers
      .map(
        (player) => `
      <tr>
        <td>
          <input
            type="checkbox"
            class="player-checkbox"
            data-player-id="${player.id}"
            ${selectedPlayerIds.has(player.id) ? 'checked' : ''}
          />
        </td>
        <td><strong>${escapeHtml(player.firstName)} ${escapeHtml(player.lastName)}</strong></td>
        <td>${player.email ? escapeHtml(player.email) : '<span style="color: #9ca3af;">-</span>'}</td>
        <td>${player.usacId ? escapeHtml(player.usacId) : '<span style="color: #9ca3af;">-</span>'}</td>
        <td>${player.role ? '<span class="role-badge">' + escapeHtml(player.role) + '</span>' : '<span style="color: #9ca3af;">-</span>'}</td>
        <td>
          <span class="status-badge ${player.isActive ? 'status-active' : 'status-inactive'}">
            ${player.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <button class="btn-icon" onclick="editPlayer('${player.id}')" title="Edit">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 3l2 2-9 9H4v-2l9-9z"/>
            </svg>
          </button>
          <button class="btn-icon btn-danger-icon" onclick="deletePlayer('${player.id}')" title="Delete">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 4h14M6 4V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1m2 0v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4h10z"/>
            </svg>
          </button>
        </td>
      </tr>
    `
      )
      .join('');

    // Add event listeners to checkboxes
    document.querySelectorAll('.player-checkbox').forEach((cb) => {
      cb.addEventListener('change', (e) => {
        const playerId = e.target.dataset.playerId;
        if (e.target.checked) {
          selectedPlayerIds.add(playerId);
        } else {
          selectedPlayerIds.delete(playerId);
        }
        updateBulkActions();
      });
    });
  }

  function updateBulkActions() {
    if (selectedPlayerIds.size > 0) {
      bulkActions.style.display = 'flex';
      selectedCount.textContent = `${selectedPlayerIds.size} selected`;
    } else {
      bulkActions.style.display = 'none';
    }

    // Update select-all checkbox state
    selectAllCheckbox.checked = selectedPlayerIds.size === filteredPlayers.length && filteredPlayers.length > 0;
  }

  // Open add player modal
  document.getElementById('add-player-btn').addEventListener('click', () => {
    editingPlayerId = null;
    document.getElementById('modal-title').textContent = 'Add New Player';
    document.getElementById('submit-btn').textContent = 'Add Player';
    playerForm.reset();
    document.getElementById('player-id').value = '';
    document.getElementById('is-active').checked = true;
    formError.style.display = 'none';
    playerModal.style.display = 'flex';
  });

  // Edit player
  window.editPlayer = (playerId) => {
    const player = players.find((p) => p.id === playerId);
    if (!player) return;

    editingPlayerId = playerId;
    document.getElementById('modal-title').textContent = 'Edit Player';
    document.getElementById('submit-btn').textContent = 'Update Player';
    document.getElementById('player-id').value = player.id;
    document.getElementById('first-name').value = player.firstName;
    document.getElementById('last-name').value = player.lastName;
    document.getElementById('email').value = player.email || '';

    // Parse phone number (format: "+1 1234567890")
    const phoneCountrySelect = document.getElementById('phone-country');
    const phoneNumberInput = document.getElementById('phone-number');
    if (player.phone) {
      const phoneMatch = player.phone.match(/^(\+\d+)\s*(.+)$/);
      if (phoneMatch) {
        phoneCountrySelect.value = phoneMatch[1];
        phoneNumberInput.value = phoneMatch[2];
      } else {
        // Old format without country code
        phoneNumberInput.value = player.phone;
      }
    } else {
      phoneCountrySelect.value = '+1';
      phoneNumberInput.value = '';
    }

    document.getElementById('usac-id').value = player.usacId || '';
    document.getElementById('role').value = player.role || '';
    document.getElementById('is-active').checked = player.isActive;

    formError.style.display = 'none';
    playerModal.style.display = 'flex';
  };

  // Delete player
  window.deletePlayer = async (playerId) => {
    const player = players.find((p) => p.id === playerId);
    if (!player) return;

    if (!confirm(`Delete ${player.firstName} ${player.lastName}? They will be marked as inactive.`)) {
      return;
    }

    try {
      const response = await fetch('/.netlify/functions/players-delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: playerId }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete player');
      }

      toast.success(`Player ${player.firstName} ${player.lastName} deleted successfully`);
      await loadPlayers();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  };

  // Submit form
  playerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    formError.style.display = 'none';

    const formData = new FormData(playerForm);
    const playerId = formData.get('id');

    const data = {
      firstName: formData.get('firstName'),
      lastName: formData.get('lastName'),
      email: formData.get('email'),
      phone: (() => {
        const phoneCountry = document.getElementById('phone-country').value;
        const phoneNumber = document.getElementById('phone-number').value.trim();
        return phoneNumber ? `${phoneCountry} ${phoneNumber}` : '';
      })(),
      usacId: formData.get('usacId'),
      role: formData.get('role'),
      isActive: document.getElementById('is-active').checked,
    };

    try {
      const url = playerId
        ? '/.netlify/functions/players-update'
        : '/.netlify/functions/players-create';
      const method = playerId ? 'PUT' : 'POST';

      if (playerId) {
        data.id = playerId;
      }

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save player');
      }

      const actionText = playerId ? 'updated' : 'created';
      toast.success(`Player ${actionText} successfully`);
      closePlayerModal();
      await loadPlayers();
    } catch (error) {
      formError.style.display = 'block';
      formErrorText.textContent = error.message;
    }
  });

  window.closePlayerModal = () => {
    playerModal.style.display = 'none';
    playerForm.reset();
    editingPlayerId = null;
  };

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Close modal on outside click
  playerModal?.addEventListener('click', (e) => {
    if (e.target === playerModal) {
      closePlayerModal();
    }
  });
</script>
