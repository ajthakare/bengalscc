---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';

// Check authentication
const cookieHeader = Astro.request.headers.get('cookie');
let authenticated = false;
let username = '';

if (cookieHeader) {
  try {
    const response = await fetch(
      `${Astro.url.origin}/.netlify/functions/auth-check`,
      {
        headers: {
          cookie: cookieHeader,
        },
      }
    );
    const data = await response.json();
    authenticated = data.authenticated;
    username = data.username || '';
  } catch (error) {
    authenticated = false;
  }
}

// Redirect to login if not authenticated
if (!authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Import Players - Bengals CC Admin" username={username} activePage="players">
  <div class="import-page">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Import Players</h1>
        <p class="page-description">Bulk import players from CSV file</p>
      </div>
      <a href="/admin/players" class="btn-secondary">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 9H3M3 9l6-6M3 9l6 6"/>
        </svg>
        Back to Players
      </a>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step active" id="step-indicator-1">
        <div class="step-number">1</div>
        <div class="step-label">Upload</div>
      </div>
      <div class="step-divider"></div>
      <div class="step" id="step-indicator-2">
        <div class="step-number">2</div>
        <div class="step-label">Validate</div>
      </div>
      <div class="step-divider"></div>
      <div class="step" id="step-indicator-3">
        <div class="step-number">3</div>
        <div class="step-label">Confirm</div>
      </div>
      <div class="step-divider"></div>
      <div class="step" id="step-indicator-4">
        <div class="step-number">4</div>
        <div class="step-label">Results</div>
      </div>
    </div>

    <!-- Step 1: Upload -->
    <div class="step-content" id="step-1">
      <div class="card">
        <h2 class="card-title">Step 1: Upload CSV File</h2>

        <div class="info-box">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
          </svg>
          <div>
            <p class="info-title">CSV Format Required</p>
            <p class="info-text"><strong>Required Columns:</strong> First Name, Last Name</p>
            <p class="info-text"><strong>Optional Columns:</strong> Email, USAC ID, Role, Status</p>
            <p class="info-text"><strong>Valid Roles:</strong> Batsman, Bowler, All-rounder, Wicket-keeper</p>
            <p class="info-text"><strong>Status:</strong> Active or Inactive (defaults to Active if not specified)</p>
          </div>
        </div>

        <div class="template-download">
          <p><strong>Don't have a template?</strong></p>
          <button id="download-template-btn" class="btn-secondary btn-sm">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 10v3a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-3M8 2v10m0 0l-3-3m3 3l3-3"/>
            </svg>
            Download CSV Template
          </button>
        </div>

        <div class="upload-zone" id="upload-zone">
          <input type="file" id="csv-file-input" accept=".csv" hidden />
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 42v6a4 4 0 004 4h24a4 4 0 004-4v-6M42 22l-10-10m0 0L22 22m10-10v28"/>
          </svg>
          <p class="upload-text">Click to upload or drag and drop</p>
          <p class="upload-hint">CSV files only (max 1000 rows)</p>
        </div>

        <div class="mode-selector">
          <label class="mode-label"><strong>Import Mode:</strong></label>
          <div class="mode-options">
            <label class="radio-label">
              <input type="radio" name="import-mode" value="create" checked />
              <span><strong>Create Only</strong> - Skip existing players</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="import-mode" value="update" />
              <span><strong>Update Only</strong> - Skip new players</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="import-mode" value="upsert" />
              <span><strong>Create & Update</strong> - Create new or update existing</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Validate -->
    <div class="step-content" id="step-2" style="display: none;">
      <div class="card">
        <h2 class="card-title">Step 2: Validation Results</h2>

        <div id="validation-summary" class="validation-summary"></div>

        <div id="validation-errors" style="display: none;">
          <h3 style="color: #dc2626; margin-bottom: 1rem;">Errors Found</h3>
          <div id="errors-list" class="errors-list"></div>
        </div>

        <div id="validation-preview">
          <h3 style="margin-bottom: 1rem;">Preview (First 10 rows)</h3>
          <div class="preview-table-container">
            <table class="preview-table" id="preview-table">
              <thead id="preview-thead"></thead>
              <tbody id="preview-tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn-secondary" onclick="goToStep(1)">Back</button>
          <button id="continue-to-confirm-btn" class="btn-primary">Continue to Confirmation</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Confirm -->
    <div class="step-content" id="step-3" style="display: none;">
      <div class="card">
        <h2 class="card-title">Step 3: Confirm Import</h2>

        <div id="confirm-summary" class="confirm-summary"></div>

        <div class="warning-box">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>
          </svg>
          <div>
            <p class="warning-title">Confirm Before Proceeding</p>
            <p class="warning-text">This action will modify your player database. Please review the summary above carefully.</p>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn-secondary" onclick="goToStep(2)">Back</button>
          <button id="start-import-btn" class="btn-primary">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 2v10m0 0l-3-3m3 3l3-3M2 14v2a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2"/>
            </svg>
            Start Import
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Results -->
    <div class="step-content" id="step-4" style="display: none;">
      <div class="card">
        <div id="results-content">
          <!-- Results will be inserted here -->
        </div>

        <div class="step-actions">
          <a href="/admin/players" class="btn-primary">View All Players</a>
          <button class="btn-secondary" onclick="resetWizard()">Import More Players</button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
      <div class="spinner-large"></div>
      <p style="margin-top: 1rem; color: #374151; font-weight: 600;">Processing import...</p>
    </div>
  </div>
</AdminLayout>

<style>
  .import-page {
    max-width: 900px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
  }

  .progress-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e5e7eb;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
  }

  .step.active .step-number {
    background: var(--color-primary);
    color: white;
  }

  .step.completed .step-number {
    background: #10b981;
    color: white;
  }

  .step-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
  }

  .step.active .step-label {
    color: #1f2937;
    font-weight: 600;
  }

  .step-divider {
    width: 60px;
    height: 2px;
    background: #e5e7eb;
    margin: 0 0.5rem;
  }

  .step.active ~ .step-divider {
    background: #e5e7eb;
  }

  .card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
  }

  .info-box {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .info-box svg {
    flex-shrink: 0;
    color: #3b82f6;
  }

  .info-title {
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 0.5rem;
  }

  .info-text {
    font-size: 0.875rem;
    color: #1e3a8a;
    margin: 0.25rem 0;
  }

  .template-download {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
  }

  .template-download p {
    margin: 0;
    color: #374151;
  }

  .upload-zone {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #f9fafb;
    margin-bottom: 1.5rem;
  }

  .upload-zone:hover {
    border-color: var(--color-primary);
    background: #f3f4f6;
  }

  .upload-zone.dragging {
    border-color: var(--color-primary);
    background: #eff6ff;
  }

  .upload-zone svg {
    margin: 0 auto 1rem;
    color: #9ca3af;
  }

  .upload-text {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
  }

  .upload-hint {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .mode-selector {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .mode-label {
    color: #374151;
    font-size: 0.875rem;
  }

  .mode-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .radio-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .radio-label:hover {
    border-color: #d1d5db;
    background: #f9fafb;
  }

  .radio-label:has(input:checked) {
    border-color: var(--color-primary);
    background: #eff6ff;
  }

  .radio-label input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .radio-label span {
    font-size: 0.875rem;
    color: #374151;
  }

  .validation-summary {
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .validation-summary .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .validation-summary .summary-item:last-child {
    border-bottom: none;
  }

  .errors-list {
    max-height: 300px;
    overflow-y: auto;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .error-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: white;
    border-left: 3px solid #dc2626;
    border-radius: 4px;
  }

  .preview-table-container {
    max-height: 400px;
    overflow: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .preview-table th {
    background: #f9fafb;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    position: sticky;
    top: 0;
  }

  .preview-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .preview-table tr:hover {
    background: #f9fafb;
  }

  .confirm-summary {
    padding: 2rem;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .confirm-summary .summary-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .confirm-summary .summary-stat:last-child {
    border-bottom: none;
    font-weight: 700;
    font-size: 1.125rem;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 2px solid #d1d5db;
  }

  .warning-box {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #fef3c7;
    border: 1px solid #fde047;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .warning-box svg {
    flex-shrink: 0;
    color: #d97706;
  }

  .warning-title {
    font-weight: 600;
    color: #92400e;
    margin-bottom: 0.25rem;
  }

  .warning-text {
    font-size: 0.875rem;
    color: #78350f;
    margin: 0;
  }

  .step-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .spinner-large {
    width: 64px;
    height: 64px;
    border: 4px solid #e5e7eb;
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script is:inline src="https://unpkg.com/papaparse@5.5.3/papaparse.min.js"></script>

<script>
  let currentStep = 1;
  let csvData = null;
  let parsedData = null;
  let validationErrors = [];
  let importMode = 'create';

  // Get import mode
  document.querySelectorAll('input[name="import-mode"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      importMode = e.target.value;
    });
  });

  // Download template
  document.getElementById('download-template-btn').addEventListener('click', () => {
    const template = 'First Name,Last Name,Email,USAC ID,Role,Status\nJohn,Doe,john@example.com,USAC12345,Batsman,Active\nJane,Smith,,,Bowler,Active\nMike,Johnson,mike@example.com,,,Inactive';
    const blob = new Blob([template], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'players-import-template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  });

  // Upload zone
  const uploadZone = document.getElementById('upload-zone');
  const csvFileInput = document.getElementById('csv-file-input');

  uploadZone.addEventListener('click', () => csvFileInput.click());

  csvFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleCSVFile(file);
  });

  // Drag and drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragging');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragging');
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragging');
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      handleCSVFile(file);
    } else {
      alert('Please upload a CSV file');
    }
  });

  function handleCSVFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      csvData = e.target.result;
      validateCSV(csvData);
    };
    reader.readAsText(file);
  }

  function validateCSV(data) {
    const result = Papa.parse(data, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (header) => header.trim(),
    });

    if (result.errors.length > 0) {
      alert('CSV parsing errors: ' + result.errors.map(e => e.message).join(', '));
      return;
    }

    parsedData = result.data;
    validationErrors = [];

    // Only First Name and Last Name are required
    const requiredFields = ['First Name', 'Last Name'];
    const validRoles = ['Batsman', 'Bowler', 'All-rounder', 'Wicket-keeper'];
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    parsedData.forEach((row, index) => {
      const rowNum = index + 2;

      // Check required fields (only First Name and Last Name)
      requiredFields.forEach(field => {
        if (!row[field] || row[field].trim() === '') {
          validationErrors.push({ row: rowNum, field, message: `Missing ${field}` });
        }
      });

      // Validate email format if provided
      if (row['Email'] && row['Email'].trim() !== '' && !emailRegex.test(row['Email'])) {
        validationErrors.push({ row: rowNum, field: 'Email', message: 'Invalid email format' });
      }

      // Validate role if provided
      if (row['Role'] && row['Role'].trim() !== '' && !validRoles.includes(row['Role'])) {
        validationErrors.push({ row: rowNum, field: 'Role', message: `Invalid role: ${row['Role']}` });
      }
    });

    // Move to validation step
    goToStep(2);
  }

  window.goToStep = (step) => {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`step-${i}`).style.display = 'none';
      document.getElementById(`step-indicator-${i}`).classList.remove('active', 'completed');
    }

    // Show current step
    document.getElementById(`step-${step}`).style.display = 'block';
    document.getElementById(`step-indicator-${step}`).classList.add('active');

    // Mark previous steps as completed
    for (let i = 1; i < step; i++) {
      document.getElementById(`step-indicator-${i}`).classList.add('completed');
    }

    currentStep = step;

    // Populate step content
    if (step === 2) {
      showValidationResults();
    } else if (step === 3) {
      showConfirmation();
    }
  };

  function showValidationResults() {
    const summary = document.getElementById('validation-summary');
    summary.innerHTML = `
      <div class="summary-item">
        <span>Total Rows:</span>
        <strong>${parsedData.length}</strong>
      </div>
      <div class="summary-item">
        <span>Valid Rows:</span>
        <strong style="color: #10b981;">${parsedData.length - validationErrors.length}</strong>
      </div>
      <div class="summary-item">
        <span>Errors:</span>
        <strong style="color: ${validationErrors.length > 0 ? '#dc2626' : '#10b981'};">${validationErrors.length}</strong>
      </div>
    `;

    // Show errors if any
    if (validationErrors.length > 0) {
      document.getElementById('validation-errors').style.display = 'block';
      const errorsList = document.getElementById('errors-list');
      errorsList.innerHTML = validationErrors.map(err => `
        <div class="error-item">
          <strong>Row ${err.row}</strong> ${err.field ? `(${err.field})` : ''}: ${err.message}
        </div>
      `).join('');

      // Disable continue button
      document.getElementById('continue-to-confirm-btn').disabled = true;
    } else {
      document.getElementById('validation-errors').style.display = 'none';
      document.getElementById('continue-to-confirm-btn').disabled = false;
    }

    // Show preview
    const previewTable = document.getElementById('preview-table');
    const thead = document.getElementById('preview-thead');
    const tbody = document.getElementById('preview-tbody');

    if (parsedData.length > 0) {
      const headers = Object.keys(parsedData[0]);
      thead.innerHTML = '<tr>' + headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';

      const previewRows = parsedData.slice(0, 10);
      tbody.innerHTML = previewRows.map(row => {
        return '<tr>' + headers.map(h => `<td>${escapeHtml(row[h] || '')}</td>`).join('') + '</tr>';
      }).join('');
    }
  }

  document.getElementById('continue-to-confirm-btn').addEventListener('click', () => {
    goToStep(3);
  });

  function showConfirmation() {
    const summary = document.getElementById('confirm-summary');
    const modeName = importMode === 'create' ? 'Create Only' : importMode === 'update' ? 'Update Only' : 'Create & Update';

    summary.innerHTML = `
      <div class="summary-stat">
        <span>Import Mode:</span>
        <strong>${modeName}</strong>
      </div>
      <div class="summary-stat">
        <span>Valid Rows to Process:</span>
        <strong>${parsedData.length - validationErrors.length}</strong>
      </div>
      <div class="summary-stat">
        <span>Rows with Errors (will be skipped):</span>
        <strong style="color: ${validationErrors.length > 0 ? '#dc2626' : '#10b981'};">${validationErrors.length}</strong>
      </div>
      <div class="summary-stat">
        <span>Total Rows to Import:</span>
        <strong>${parsedData.length - validationErrors.length}</strong>
      </div>
    `;
  }

  document.getElementById('start-import-btn').addEventListener('click', async () => {
    document.getElementById('loading-overlay').style.display = 'flex';

    try {
      const response = await fetch('/.netlify/functions/players-import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          csvData,
          mode: importMode,
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to import players');
      }

      showResults(result.data);
      goToStep(4);
    } catch (error) {
      alert('Error: ' + error.message);
    } finally {
      document.getElementById('loading-overlay').style.display = 'none';
    }
  });

  function showResults(data) {
    const resultsContent = document.getElementById('results-content');
    const hasErrors = data.errors && data.errors.length > 0;

    resultsContent.innerHTML = `
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: ${hasErrors ? '#fef3c7' : '#d1fae5'}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none" stroke="${hasErrors ? '#d97706' : '#10b981'}" stroke-width="3">
            ${hasErrors ? '<path d="M24 16v12M24 36h.01"/><circle cx="24" cy="24" r="20"/>' : '<path d="M9 24l9 9L39 12"/>'}
          </svg>
        </div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
          ${hasErrors ? 'Import Completed with Errors' : 'Import Successful!'}
        </h2>
        <p style="color: #6b7280;">Your player import has been processed</p>
      </div>

      <div style="padding: 2rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1.5rem;">
        <div class="summary-stat">
          <span>Players Created:</span>
          <strong style="color: #10b981;">${data.created}</strong>
        </div>
        <div class="summary-stat">
          <span>Players Updated:</span>
          <strong style="color: #3b82f6;">${data.updated}</strong>
        </div>
        <div class="summary-stat">
          <span>Errors:</span>
          <strong style="color: ${data.errors.length > 0 ? '#dc2626' : '#10b981'};">${data.errors.length}</strong>
        </div>
      </div>

      ${hasErrors ? `
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
          <h3 style="color: #dc2626; margin-bottom: 0.5rem;">Errors (${data.errors.length})</h3>
          <div style="max-height: 200px; overflow-y: auto;">
            ${data.errors.map(err => `
              <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: white; border-left: 3px solid #dc2626; border-radius: 4px; font-size: 0.875rem;">
                <strong>Row ${err.row}:</strong> ${err.message}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    `;
  }

  window.resetWizard = () => {
    currentStep = 1;
    csvData = null;
    parsedData = null;
    validationErrors = [];
    csvFileInput.value = '';
    goToStep(1);
  };

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
