---
import Layout from '../layouts/Layout.astro';
import Section from '../components/Section.astro';
import Papa from 'papaparse';
import { readFileSync } from 'fs';

// Our teams
const OUR_TEAMS = ['Bengal Tigers', 'Bengal Bulls', 'Bengal Thunder Cats'];

// Read and parse CSV
const csvData = readFileSync('src/data/fixtures.csv', 'utf-8');
const { data } = Papa.parse(csvData, {
    header: true,
    skipEmptyLines: true
});

// Process fixtures
interface Fixture {
    gameNumber: string;
    week: string;
    date: string;
    division: string;
    time: string;
    homeTeam: string;
    visitorTeam: string;
    venue: string;
    groundAddress: string;
    umpire: string;
    ourTeam: string;
    opponent: string;
    isHome: boolean;
    monthYear: string;
    sortDate: Date;
}

const fixtures: Fixture[] = data
    .filter((row: any) => {
        // Filter rows that include any of our teams
        return OUR_TEAMS.some(team =>
            row['Home Team'] === team || row['Visitor Team'] === team
        );
    })
    .map((row: any) => {
        const homeTeam = row['Home Team'];
        const visitorTeam = row['Visitor Team'];

        // Determine which is our team and which is opponent
        const ourTeam = OUR_TEAMS.find(team =>
            team === homeTeam || team === visitorTeam
        ) || '';
        const isHome = homeTeam === ourTeam;
        const opponent = isHome ? visitorTeam : homeTeam;

        // Parse date for sorting and grouping
        const dateStr = row['Date'];

        // Date now includes year (e.g., "Sat, Nov 1, 2025")
        const sortDate = new Date(dateStr);

        const monthYear = sortDate.toLocaleString('default', {
            month: 'long',
            year: 'numeric'
        });

        return {
            gameNumber: row['Game#'],
            week: row['Week#'],
            date: dateStr,
            division: row['Division'],
            time: row['Start Time'],
            homeTeam,
            visitorTeam,
            venue: row['Venue Name'],
            groundAddress: row['Ground Address'],
            umpire: row['Umpiring Team'],
            ourTeam,
            opponent,
            isHome,
            monthYear,
            sortDate
        };
    })
    .sort((a: Fixture, b: Fixture) => a.sortDate.getTime() - b.sortDate.getTime());

// Get current date to determine upcoming vs past
const today = new Date();
today.setHours(0, 0, 0, 0); // Reset to start of day

const upcomingFixtures = fixtures.filter(f => f.sortDate >= today);
const pastFixtures = fixtures.filter(f => f.sortDate < today).reverse();

// Get all matches on the upcoming weekend (next Sat/Sun)
function getUpcomingWeekendMatches(matches: Fixture[]): Fixture[] {
    if (matches.length === 0) return [];

    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // Find the next Saturday
    let nextSaturday = new Date(now);
    const daysUntilSaturday = (6 - now.getDay() + 7) % 7;
    if (daysUntilSaturday === 0 && now.getDay() !== 6) {
        // If today is not Saturday, get next Saturday
        nextSaturday.setDate(now.getDate() + 7);
    } else {
        nextSaturday.setDate(now.getDate() + daysUntilSaturday);
    }

    // If today is Saturday or Sunday, use this weekend
    if (now.getDay() === 6 || now.getDay() === 0) {
        nextSaturday = new Date(now);
        if (now.getDay() === 0) {
            // If today is Sunday, go back to Saturday
            nextSaturday.setDate(now.getDate() - 1);
        }
    }

    const nextSunday = new Date(nextSaturday);
    nextSunday.setDate(nextSaturday.getDate() + 1);

    // Get all matches on Saturday or Sunday
    return matches.filter(match => {
        const matchDate = new Date(match.sortDate);
        matchDate.setHours(0, 0, 0, 0);

        const saturdayTime = nextSaturday.getTime();
        const sundayTime = nextSunday.getTime();
        const matchTime = matchDate.getTime();

        return matchTime === saturdayTime || matchTime === sundayTime;
    });
}

const upcomingWeekendMatches = getUpcomingWeekendMatches(upcomingFixtures);

// Group upcoming fixtures by month
const upcomingByMonth = upcomingFixtures.reduce((acc: Record<string, Fixture[]>, fixture: Fixture) => {
    if (!acc[fixture.monthYear]) {
        acc[fixture.monthYear] = [];
    }
    acc[fixture.monthYear].push(fixture);
    return acc;
}, {});

// Group past fixtures by month
const pastByMonth = pastFixtures.reduce((acc: Record<string, Fixture[]>, fixture: Fixture) => {
    if (!acc[fixture.monthYear]) {
        acc[fixture.monthYear] = [];
    }
    acc[fixture.monthYear].push(fixture);
    return acc;
}, {});

// Get team color based on team name
function getTeamColor(teamName: string): string {
    if (teamName.includes('Tigers')) return 'bg-orange-100 border-orange-300 text-orange-800';
    if (teamName.includes('Bulls')) return 'bg-blue-100 border-blue-300 text-blue-800';
    if (teamName.includes('Thunder')) return 'bg-purple-100 border-purple-300 text-purple-800';
    return 'bg-gray-100 border-gray-300 text-gray-800';
}
---

<Layout title="Match Fixtures - Bengals Cricket Club">
    <h1 class="text-4xl sm:text-5xl font-bold mb-3">Match Fixtures</h1>
    <p class="text-xl text-gray-600 mb-8">Winter 2025-2026 Season</p>

    {/* Upcoming Weekend Matches */}
    {upcomingWeekendMatches.length > 0 ? (
        <Section>
            <div class="bg-gradient-to-r from-primary/10 to-complementary/10 border-2 border-primary rounded-xl p-6 mb-8">
                <div class="flex items-center gap-2 mb-6">
                    <span class="text-2xl">üèè</span>
                    <h2 class="text-2xl font-bold text-gray-900">
                        {upcomingWeekendMatches.length === 1 ? 'Upcoming Weekend Match' : 'Upcoming Weekend Matches'}
                    </h2>
                    <span class="px-3 py-1 bg-primary/20 text-primary rounded-full text-sm font-semibold">
                        {upcomingWeekendMatches.length} {upcomingWeekendMatches.length === 1 ? 'match' : 'matches'}
                    </span>
                </div>
                <div class={`grid gap-6 ${upcomingWeekendMatches.length === 1 ? 'md:grid-cols-1' : upcomingWeekendMatches.length === 2 ? 'md:grid-cols-2' : 'md:grid-cols-3'}`}>
                    {upcomingWeekendMatches.map(match => (
                        <div class="fixture-card bg-white rounded-lg border-2 border-gray-200 p-5" data-team={match.ourTeam}>
                            <div class={`inline-block px-4 py-2 rounded-full text-base font-bold mb-3 ${getTeamColor(match.ourTeam)}`}>
                                {match.ourTeam}
                            </div>
                            <div class="text-xl font-bold text-gray-900 mb-2">
                                vs <span class="text-lg">{match.opponent}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-700 mb-2">
                                <span class="text-lg">üìÖ</span>
                                <span class="font-semibold text-sm">{match.date}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-700 mb-3">
                                <span class="text-lg">üïê</span>
                                <span class="text-sm">{match.time}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600 mb-3">
                                <span>{match.isHome ? 'üè†' : '‚úàÔ∏è'}</span>
                                <span class="font-medium text-sm">{match.isHome ? 'Home' : 'Away'} Game</span>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                <div class="font-semibold text-gray-900 text-sm mb-1 flex items-center gap-2">
                                    <span>üèüÔ∏è</span>
                                    <span>{match.venue}</span>
                                </div>
                                <div class="text-xs text-gray-600 flex items-start gap-2">
                                    <span>üìç</span>
                                    <span>{match.groundAddress}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    {match.division}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </Section>
    ) : (
        <Section>
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl p-8 mb-8 text-center">
                <div class="flex items-center justify-center gap-2 mb-4">
                    <span class="text-3xl">üìÖ</span>
                    <h2 class="text-2xl font-bold text-gray-900">Upcoming Weekend</h2>
                </div>
                <p class="text-lg text-gray-700 mb-2">
                    No matches scheduled for the upcoming weekend.
                </p>
                <p class="text-gray-600">
                    Check the <strong>Upcoming Fixtures</strong> section below to view the full schedule.
                </p>
            </div>
        </Section>
    )}

    {/* Team Filter Buttons */}
    <div class="mb-8">
        <div class="flex flex-wrap gap-3 items-center">
            <span class="text-sm font-medium text-gray-700">Filter by team:</span>
            <button
                class="filter-btn active px-4 py-2 rounded-lg font-semibold transition-all border-2"
                data-team="all"
            >
                All Teams ({fixtures.length})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all border-2 bg-orange-100 border-orange-300 text-orange-800 hover:bg-orange-200"
                data-team="Bengal Tigers"
            >
                Bengal Tigers ({fixtures.filter(f => f.ourTeam === 'Bengal Tigers').length})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all border-2 bg-blue-100 border-blue-300 text-blue-800 hover:bg-blue-200"
                data-team="Bengal Bulls"
            >
                Bengal Bulls ({fixtures.filter(f => f.ourTeam === 'Bengal Bulls').length})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-lg font-semibold transition-all border-2 bg-purple-100 border-purple-300 text-purple-800 hover:bg-purple-200"
                data-team="Bengal Thunder Cats"
            >
                Bengal Thunder Cats ({fixtures.filter(f => f.ourTeam === 'Bengal Thunder Cats').length})
            </button>
        </div>
    </div>

    {/* Quick Stats */}
    <div class="grid grid-cols-3 gap-4 mb-8" id="stats-container">
        <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-center gap-3 mb-2">
                <div class="text-4xl">üèè</div>
                <div class="text-3xl font-bold text-primary" id="total-matches">{fixtures.length}</div>
            </div>
            <div class="text-sm text-gray-600 text-center">Total Matches</div>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-center gap-3 mb-2">
                <div class="text-4xl">üè†</div>
                <div class="text-3xl font-bold text-complementary" id="home-games">{fixtures.filter(f => f.isHome).length}</div>
            </div>
            <div class="text-sm text-gray-600 text-center">Home Games</div>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-center gap-3 mb-2">
                <div class="text-4xl">‚úàÔ∏è</div>
                <div class="text-3xl font-bold text-gray-700" id="away-games">{fixtures.filter(f => !f.isHome).length}</div>
            </div>
            <div class="text-sm text-gray-600 text-center">Away Games</div>
        </div>
    </div>

    {/* Upcoming Fixtures Section - Collapsible */}
    {upcomingFixtures.length > 0 && (
        <div class="mb-12">
            <button
                id="upcoming-fixtures-toggle"
                class="flex items-center justify-between w-full bg-orange-100 hover:bg-orange-200 rounded-lg p-6 transition-all mb-6"
            >
                <div class="flex items-center gap-3">
                    <h2 class="text-4xl font-bold text-gray-900">üèè Upcoming Fixtures</h2>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">
                        <span id="upcoming-count">{upcomingFixtures.length}</span> matches
                    </span>
                </div>
                <svg
                    id="upcoming-fixtures-icon"
                    class="w-8 h-8 transition-transform rotate-180"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <div id="upcoming-fixtures-content">

            {Object.entries(upcomingByMonth).map(([month, monthFixtures]) => (
                <div class="month-section mb-0">
                    <Section>
                        <div class="mb-6">
                            <h3 class="text-3xl font-bold text-gray-900 bg-gradient-to-r from-blue-100 to-blue-200 border-l-4 border-blue-600 px-6 py-4 rounded-lg">{month}</h3>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                        {monthFixtures.map((fixture) => (
                            <div
                                class="fixture-card border-2 rounded-xl p-6 transition-all hover:shadow-lg bg-white border-gray-300 hover:border-primary"
                                data-team={fixture.ourTeam}
                                data-is-home={fixture.isHome}
                                data-is-past="false"
                            >
                                {/* Header */}
                                <div class="flex items-start justify-between mb-4">
                                    <div class={`px-4 py-2 rounded-full text-base font-bold ${getTeamColor(fixture.ourTeam)}`}>
                                        {fixture.ourTeam}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">{fixture.isHome ? 'üè†' : '‚úàÔ∏è'}</span>
                                        <span class={`text-sm font-semibold ${
                                            fixture.isHome ? 'text-green-700' : 'text-blue-700'
                                        }`}>
                                            {fixture.isHome ? 'HOME' : 'AWAY'}
                                        </span>
                                    </div>
                                </div>

                                {/* Match Info */}
                                <div class="mb-4">
                                    <div class="text-xl font-bold text-gray-900 mb-2">
                                        vs <span class="text-lg">{fixture.opponent}</span>
                                    </div>
                                    <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                                        <span>üìÖ {fixture.date}</span>
                                        <span>üïê {fixture.time}</span>
                                        <span class="px-2 py-0.5 bg-gray-100 rounded text-xs font-medium">
                                            {fixture.division}
                                        </span>
                                    </div>
                                </div>

                                {/* Venue Info */}
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                    <div class="font-semibold text-gray-900 mb-1 flex items-center gap-2">
                                        <span>üèüÔ∏è</span>
                                        <span>{fixture.venue}</span>
                                    </div>
                                    <div class="text-sm text-gray-600 flex items-start gap-2">
                                        <span>üìç</span>
                                        <span>{fixture.groundAddress}</span>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                    <div class="flex justify-between items-center">
                                        <span>Game #{fixture.gameNumber} ‚Ä¢ {fixture.week}</span>
                                        <span>Umpire: {fixture.umpire}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                        </div>
                    </Section>
                </div>
            ))}
            </div>
        </div>
    )}

    {/* Past Fixtures Section - Collapsible */}
    {pastFixtures.length > 0 && (
        <div class="mb-12">
            <button
                id="past-fixtures-toggle"
                class="flex items-center justify-between w-full bg-gray-200 hover:bg-gray-300 rounded-lg p-6 transition-all mb-6"
            >
                <div class="flex items-center gap-3">
                    <h2 class="text-4xl font-bold text-gray-900">üìã Past Fixtures</h2>
                    <span class="px-3 py-1 bg-gray-300 text-gray-700 rounded-full text-sm font-semibold">
                        <span id="past-count">{pastFixtures.length}</span> matches
                    </span>
                </div>
                <svg
                    id="past-fixtures-icon"
                    class="w-8 h-8 transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <div id="past-fixtures-content" class="hidden">
                {Object.entries(pastByMonth).map(([month, monthFixtures]) => (
                    <div class="month-section mb-0">
                        <Section>
                            <div class="mb-6">
                                <h3 class="text-3xl font-bold text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400 px-6 py-4 rounded-lg">{month}</h3>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                            {monthFixtures.map((fixture) => (
                                <div
                                    class="fixture-card border-2 rounded-xl p-6 transition-all hover:shadow-lg bg-gray-50 border-gray-200 opacity-75"
                                    data-team={fixture.ourTeam}
                                    data-is-home={fixture.isHome}
                                    data-is-past="true"
                                >
                                    {/* Header */}
                                    <div class="flex items-start justify-between mb-4">
                                        <div class={`px-4 py-2 rounded-full text-base font-bold ${getTeamColor(fixture.ourTeam)}`}>
                                            {fixture.ourTeam}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">{fixture.isHome ? 'üè†' : '‚úàÔ∏è'}</span>
                                            <span class={`text-sm font-semibold ${
                                                fixture.isHome ? 'text-green-700' : 'text-blue-700'
                                            }`}>
                                                {fixture.isHome ? 'HOME' : 'AWAY'}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Match Info */}
                                    <div class="mb-4">
                                        <div class="text-xl font-bold text-gray-900 mb-2">
                                            vs <span class="text-lg">{fixture.opponent}</span>
                                        </div>
                                        <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                                            <span>üìÖ {fixture.date}</span>
                                            <span>üïê {fixture.time}</span>
                                            <span class="px-2 py-0.5 bg-gray-100 rounded text-xs font-medium">
                                                {fixture.division}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Venue Info */}
                                    <div class="bg-gray-100 rounded-lg p-3 border border-gray-200">
                                        <div class="font-semibold text-gray-900 mb-1 flex items-center gap-2">
                                            <span>üèüÔ∏è</span>
                                            <span>{fixture.venue}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 flex items-start gap-2">
                                            <span>üìç</span>
                                            <span>{fixture.groundAddress}</span>
                                        </div>
                                    </div>

                                    {/* Footer */}
                                    <div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                        <div class="flex justify-between items-center">
                                            <span>Game #{fixture.gameNumber} ‚Ä¢ {fixture.week}</span>
                                            <span>Umpire: {fixture.umpire}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            </div>
                        </Section>
                    </div>
                ))}
            </div>
        </div>
    )}

    {/* No Fixtures Message */}
    {fixtures.length === 0 && (
        <Section>
            <div class="text-center py-12">
                <span class="text-6xl mb-4 block">üèè</span>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">No Fixtures Available</h2>
                <p class="text-gray-600">Check back soon for upcoming match schedules.</p>
            </div>
        </Section>
    )}
</Layout>

<style>
    /* Smooth hover transitions */
    .hover\:shadow-lg {
        transition: all 0.2s ease-in-out;
    }

    /* Active filter button */
    .filter-btn.active {
        background-color: #f67280;
        border-color: #f67280;
        color: white;
    }

    .filter-btn:not(.active) {
        background-color: white;
        border-color: #e5e7eb;
        color: #374151;
    }

    .filter-btn:not(.active):hover {
        border-color: #f67280;
    }

    /* Hide filtered cards */
    .fixture-card.hidden {
        display: none;
    }
</style>

<script>
    // Team filter functionality
    document.addEventListener('DOMContentLoaded', () => {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const fixtureCards = document.querySelectorAll('.fixture-card');
        const upcomingToggle = document.getElementById('upcoming-fixtures-toggle');
        const upcomingContent = document.getElementById('upcoming-fixtures-content');
        const upcomingIcon = document.getElementById('upcoming-fixtures-icon');
        const pastToggle = document.getElementById('past-fixtures-toggle');
        const pastContent = document.getElementById('past-fixtures-content');
        const pastIcon = document.getElementById('past-fixtures-icon');

        // Check for team parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const teamFromUrl = urlParams.get('team');

        // Toggle upcoming fixtures section
        if (upcomingToggle && upcomingContent && upcomingIcon) {
            upcomingToggle.addEventListener('click', () => {
                const isHidden = upcomingContent.classList.contains('hidden');

                if (isHidden) {
                    upcomingContent.classList.remove('hidden');
                    upcomingIcon.style.transform = 'rotate(180deg)';
                } else {
                    upcomingContent.classList.add('hidden');
                    upcomingIcon.style.transform = 'rotate(0deg)';
                }
            });
        }

        // Toggle past fixtures section
        if (pastToggle && pastContent && pastIcon) {
            pastToggle.addEventListener('click', () => {
                const isHidden = pastContent.classList.contains('hidden');

                if (isHidden) {
                    pastContent.classList.remove('hidden');
                    pastIcon.style.transform = 'rotate(180deg)';
                } else {
                    pastContent.classList.add('hidden');
                    pastIcon.style.transform = 'rotate(0deg)';
                }
            });
        }

        // Team filter functionality
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const selectedTeam = button.getAttribute('data-team');

                // Update active button
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Filter cards
                let visibleCount = 0;
                let homeCount = 0;
                let awayCount = 0;
                let upcomingCount = 0;
                let pastCount = 0;

                fixtureCards.forEach(card => {
                    const cardTeam = card.getAttribute('data-team');
                    const isHome = card.getAttribute('data-is-home') === 'true';
                    const isPast = card.getAttribute('data-is-past') === 'true';

                    if (selectedTeam === 'all' || cardTeam === selectedTeam) {
                        card.classList.remove('hidden');
                        visibleCount++;
                        if (isHome) homeCount++;
                        else awayCount++;
                        if (isPast) pastCount++;
                        else upcomingCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });

                // Update stats
                document.getElementById('total-matches').textContent = visibleCount;
                document.getElementById('home-games').textContent = homeCount;
                document.getElementById('away-games').textContent = awayCount;

                // Update section counts
                const upcomingCountEl = document.getElementById('upcoming-count');
                const pastCountEl = document.getElementById('past-count');
                if (upcomingCountEl) upcomingCountEl.textContent = upcomingCount;
                if (pastCountEl) pastCountEl.textContent = pastCount;

                // Hide empty month sections
                const monthSections = document.querySelectorAll('.month-section');
                monthSections.forEach(section => {
                    const visibleCards = section.querySelectorAll('.fixture-card:not(.hidden)');
                    if (visibleCards.length === 0) {
                        section.style.display = 'none';
                    } else {
                        section.style.display = 'block';
                    }
                });
            });
        });

        // Auto-apply team filter from URL parameter
        if (teamFromUrl) {
            const teamButton = Array.from(filterButtons).find(btn =>
                btn.getAttribute('data-team') === teamFromUrl
            );

            if (teamButton) {
                // Trigger click on the team button
                teamButton.click();

                // Scroll to the fixtures section
                setTimeout(() => {
                    const fixturesSection = document.querySelector('.grid.md\\:grid-cols-2');
                    if (fixturesSection) {
                        fixturesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }
    });
</script>
// Trigger reload
