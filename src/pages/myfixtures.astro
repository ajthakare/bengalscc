---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { validateAdminSession, isMember } from '../middleware/auth';

// Check authentication
const cookieHeader = Astro.request.headers.get('cookie');
const session = validateAdminSession(cookieHeader || '');

// Redirect to login if not authenticated
if (!session || !isMember(session)) {
  return Astro.redirect('/login');
}
---

<Layout title="My Fixtures - Golden State Cricket Club">
  <h1 class="page-title heading-margin-sm">My Upcoming Fixtures</h1>
  <p class="text-intro mb-8">Next 7 days - Mark your availability for upcoming matches</p>

  <div class="max-w-5xl mx-auto px-4 py-8">

    <!-- Loading State -->
    <div id="loading" class="state-container">
      <div class="spinner"></div>
      <p class="state-text">Loading fixtures...</p>
    </div>

    <!-- Error State -->
    <div id="error-container" class="alert alert-error" style="display: none;">
      <p id="error-text"></p>
    </div>

    <!-- No Fixtures State -->
    <div id="no-fixtures" class="state-container" style="display: none;">
      <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
      <p class="empty-text">No upcoming fixtures in the next 7 days</p>
      <p class="empty-subtext">Check back later for new fixtures</p>
    </div>

    <!-- Fixtures Grid -->
    <div id="fixtures-grid" class="fixtures-grid" style="display: none;">
      <!-- Fixtures will be inserted here -->
    </div>
  </div>

  <script>
    let fixtures: any[] = [];

    async function loadFixtures() {
      const loading = document.getElementById('loading');
      const errorContainer = document.getElementById('error-container');
      const errorText = document.getElementById('error-text');
      const noFixtures = document.getElementById('no-fixtures');
      const fixturesGrid = document.getElementById('fixtures-grid');

      try {
        loading!.style.display = 'flex';
        errorContainer!.style.display = 'none';
        noFixtures!.style.display = 'none';
        fixturesGrid!.style.display = 'none';

        console.log('Fetching fixtures from API...');
        const response = await fetch('/.netlify/functions/member-fixtures-list', {
          credentials: 'same-origin',
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const data = await response.json();
          console.error('API error:', data);
          throw new Error(data.error || 'Failed to load fixtures');
        }

        fixtures = await response.json();
        console.log('Loaded fixtures:', fixtures);

        loading!.style.display = 'none';

        if (fixtures.length === 0) {
          console.log('No fixtures found');
          noFixtures!.style.display = 'flex';
        } else {
          console.log(`Displaying ${fixtures.length} fixtures`);
          fixturesGrid!.style.display = 'grid';
          renderFixtures();
        }
      } catch (error) {
        console.error('Error loading fixtures:', error);
        loading!.style.display = 'none';
        errorContainer!.style.display = 'block';
        errorText!.textContent = error instanceof Error ? error.message : 'Unknown error';
      }
    }

    function renderFixtures() {
      const fixturesGrid = document.getElementById('fixtures-grid');
      if (!fixturesGrid) return;

      fixturesGrid.innerHTML = '';

      fixtures.forEach((fixture) => {
        const card = document.createElement('div');
        card.className = 'fixture-card';

        const fixtureDate = new Date(fixture.date);
        const formattedDate = fixtureDate.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
        });

        const statusClass = fixture.myAvailability === true
          ? 'status-available'
          : fixture.myAvailability === false
          ? 'status-unavailable'
          : 'status-pending';

        const statusText = fixture.myAvailability === true
          ? '‚úì Available'
          : fixture.myAvailability === false
          ? '‚úó Not Available'
          : 'No Response';

        // Get team color
        const teamColor = fixture.team.includes('Tigers')
          ? 'bg-amber-100 border-amber-300 text-amber-900'
          : fixture.team.includes('Bulls')
          ? 'bg-blue-100 border-blue-300 text-blue-800'
          : fixture.team.includes('Thunder')
          ? 'bg-purple-100 border-purple-300 text-purple-800'
          : 'bg-gray-100 border-gray-300 text-gray-800';

        // Determine if home or away game
        const isHome = fixture.isHomeTeam !== undefined ? fixture.isHomeTeam : true;
        const homeAwayIcon = isHome ? 'üè†' : '‚úàÔ∏è';
        const homeAwayText = isHome ? 'HOME' : 'AWAY';
        const homeAwayColor = isHome ? 'text-green-700' : 'text-blue-700';

        // Match fixtures.astro card layout exactly
        card.innerHTML = `
          <!-- Header - Team badge + Home/Away -->
          <div class="flex items-start justify-between mb-4">
            <div class="px-4 py-2 rounded-full text-base font-bold ${teamColor}">
              ${fixture.team}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-lg">${homeAwayIcon}</span>
              <span class="text-sm font-semibold ${homeAwayColor}">
                ${homeAwayText}
              </span>
            </div>
          </div>

          <!-- Match Info -->
          <div class="mb-4">
            <div class="text-xl font-bold text-gray-900 mb-2">
              vs <span class="text-lg">${fixture.opponent}</span>
            </div>
            <div class="flex flex-wrap gap-3 text-sm text-gray-600">
              <span>üìÖ ${formattedDate}</span>
              <span>üïê ${fixture.time}</span>
              <span class="px-2 py-0.5 bg-gray-100 rounded text-xs font-medium">
                ${fixture.division}
              </span>
            </div>
          </div>

          <!-- Venue Info -->
          <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 mb-4">
            <div class="font-semibold text-gray-900 mb-1 flex items-center gap-2">
              <span>üèüÔ∏è</span>
              <span>${fixture.venue}</span>
            </div>
            ${fixture.groundAddress ? `
              <div class="text-sm text-gray-600 flex items-start gap-2">
                <span>üìç</span>
                <span>${fixture.groundAddress}</span>
              </div>
            ` : ''}
          </div>

          <!-- Availability Section -->
          <div class="border-t-2 border-gray-200 pt-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-bold text-gray-700 uppercase">Your Availability</h4>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>

            <div class="availability-buttons">
              <button
                class="btn-available ${fixture.myAvailability === true ? 'active' : ''}"
                onclick="updateAvailability('${fixture.id}', true)"
              >
                ‚úì Available
              </button>
              <button
                class="btn-unavailable ${fixture.myAvailability === false ? 'active' : ''}"
                onclick="updateAvailability('${fixture.id}', false)"
              >
                ‚úó Not Available
              </button>
            </div>

            ${fixture.submittedAt ? `
              <p class="last-updated">Last updated: ${new Date(fixture.submittedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</p>
            ` : ''}
          </div>

          <!-- Team Stats -->
          <div class="border-t border-gray-200 pt-3 mt-4">
            <p class="text-xs text-gray-600 font-semibold mb-2 uppercase">Team Responses</p>
            <div class="flex gap-3 text-xs">
              <span class="text-green-700 font-medium">‚úì ${fixture.availabilityCounts.available} Available</span>
              <span class="text-red-700 font-medium">‚úó ${fixture.availabilityCounts.unavailable} Unavailable</span>
              <span class="text-gray-600 font-medium">${fixture.availabilityCounts.noResponse} Pending</span>
            </div>
          </div>
        `;

        fixturesGrid.appendChild(card);
      });
    }

    async function updateAvailability(fixtureId: string, available: boolean) {
      try {
        const response = await fetch('/.netlify/functions/member-availability-update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify({ fixtureId, available }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to update availability');
        }

        // Update local fixture data
        const fixtureIndex = fixtures.findIndex(f => f.id === fixtureId);
        if (fixtureIndex !== -1) {
          fixtures[fixtureIndex].myAvailability = available;
          fixtures[fixtureIndex].submittedAt = data.submittedAt;
        }

        // Re-render fixtures
        renderFixtures();

        // Show success message (optional)
        showToast(available ? 'Marked as available' : 'Marked as not available');
      } catch (error) {
        alert('Failed to update availability: ' + (error instanceof Error ? error.message : 'Unknown error'));
      }
    }

    function showToast(message: string) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('show');
      }, 100);

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 2000);
    }

    // Make updateAvailability globally available
    (window as any).updateAvailability = updateAvailability;

    // Load fixtures on page load
    loadFixtures();
  </script>

  <style is:global>
    .state-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 64px 24px;
      text-align: center;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #f67280;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .state-text {
      margin-top: 16px;
      font-size: 16px;
      color: #6b7280;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }

    .empty-text {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .empty-subtext {
      font-size: 14px;
      color: #6b7280;
    }

    .alert {
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 24px;
    }

    .alert-error {
      background: #fef2f2;
      border: 2px solid #fecaca;
      color: #dc2626;
    }

    .fixtures-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 768px) {
      .fixtures-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .fixture-card {
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 0.75rem;
      padding: 1.5rem;
      transition: all 0.2s ease-in-out;
    }

    .fixture-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border-color: #f67280;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }

    .status-available {
      background: #d1fae5;
      color: #065f46;
    }

    .status-unavailable {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .availability-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn-available, .btn-unavailable {
      padding: 10px;
      border: 2px solid;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      text-align: center;
    }

    .btn-available {
      color: #059669;
      border-color: #d1fae5;
    }

    .btn-available:hover {
      border-color: #10b981;
      background: #ecfdf5;
    }

    .btn-available.active {
      border-color: #10b981;
      background: #10b981;
      color: white;
    }

    .btn-unavailable {
      color: #dc2626;
      border-color: #fee2e2;
    }

    .btn-unavailable:hover {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .btn-unavailable.active {
      border-color: #ef4444;
      background: #ef4444;
      color: white;
    }

    .notes-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .notes-input:focus {
      outline: none;
      border-color: #f67280;
    }

    .last-updated {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #111827;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</Layout>
