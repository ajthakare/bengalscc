---
import Layout from '../layouts/Layout.astro';
import { validateAdminSession } from '../middleware/auth';

export const prerender = false;

// Check if already logged in
const cookieHeader = Astro.request.headers.get('cookie');
const session = validateAdminSession(cookieHeader || '');

// Redirect to home if already logged in
if (session) {
  return Astro.redirect('/');
}
---

<Layout title="Register - Golden State Cricket Club">
  <div class="max-w-md mx-auto px-4 py-12">
    <div class="card">
      <h1 class="page-title text-center mb-6">Member Registration</h1>

      <p class="text-body mb-6 text-center text-gray-600">
        Join Golden State Cricket Club as a member. After registration, an admin will review your request.
      </p>

      <form id="register-form" class="space-y-4">
        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
            Email <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
            placeholder="john@example.com"
          />
          <p class="text-xs text-gray-500 mt-1">This will be your login email</p>
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
            Password <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="8"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
              placeholder="Minimum 8 characters"
            />
            <button
              type="button"
              id="toggle-password"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
            >
              <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
          <div id="password-strength" class="mt-1 text-xs"></div>
        </div>

        <!-- Confirm Password -->
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">
            Confirm Password <span class="text-red-500">*</span>
          </label>
          <input
            type="password"
            id="confirmPassword"
            name="confirmPassword"
            required
            minlength="8"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
            placeholder="Re-enter password"
          />
          <p id="password-match-error" class="text-xs text-red-600 mt-1 hidden">Passwords do not match</p>
        </div>

        <!-- First Name -->
        <div>
          <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
            First Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="firstName"
            name="firstName"
            required
            maxlength="100"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
            placeholder="John"
          />
        </div>

        <!-- Last Name -->
        <div>
          <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
            Last Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="lastName"
            name="lastName"
            required
            maxlength="100"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
            placeholder="Doe"
          />
        </div>

        <!-- Phone (Optional) -->
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
            Phone <span class="text-gray-400">(Optional)</span>
          </label>
          <div class="flex gap-2">
            <select
              id="phone-country"
              name="phoneCountry"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280] w-28"
            >
              <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
              <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
              <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
              <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
              <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
              <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
              <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
              <option value="+33">ðŸ‡«ðŸ‡· +33</option>
              <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
              <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
            </select>
            <input
              type="tel"
              id="phone"
              name="phoneNumber"
              class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#f67280]"
              placeholder="1234567890"
              pattern="[0-9]{7,15}"
            />
          </div>
          <p class="text-xs text-gray-500 mt-1">Enter phone number without country code</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>

        <!-- Success Message -->
        <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded"></div>

        <!-- Submit Button -->
        <button
          type="submit"
          id="submit-btn"
          class="w-full btn btn-lg"
        >
          Register
        </button>
      </form>

      <p class="text-center text-sm text-gray-600 mt-6">
        Already have an account? <a href="/login" class="text-[#f67280] hover:underline">Login here</a>
      </p>
    </div>
  </div>

  <script>
    // Password toggle
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const togglePasswordBtn = document.getElementById('toggle-password');

    togglePasswordBtn?.addEventListener('click', () => {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
      } else {
        passwordInput.type = 'password';
      }
    });

    // Password strength indicator
    const passwordStrengthEl = document.getElementById('password-strength');
    passwordInput?.addEventListener('input', () => {
      const password = passwordInput.value;
      let strength = '';
      let color = '';

      if (password.length === 0) {
        strength = '';
      } else if (password.length < 8) {
        strength = 'Weak (minimum 8 characters)';
        color = 'text-red-600';
      } else if (password.length < 12) {
        strength = 'Fair';
        color = 'text-yellow-600';
      } else {
        strength = 'Strong';
        color = 'text-green-600';
      }

      if (passwordStrengthEl) {
        passwordStrengthEl.textContent = strength;
        passwordStrengthEl.className = `mt-1 text-xs ${color}`;
      }
    });

    // Password match validation
    const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
    const passwordMatchError = document.getElementById('password-match-error');

    confirmPasswordInput?.addEventListener('input', () => {
      if (confirmPasswordInput.value !== passwordInput.value && confirmPasswordInput.value.length > 0) {
        passwordMatchError?.classList.remove('hidden');
      } else {
        passwordMatchError?.classList.add('hidden');
      }
    });

    // Form submission
    const form = document.getElementById('register-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset messages
      errorMessage?.classList.add('hidden');
      successMessage?.classList.add('hidden');

      // Get form data
      const formData = new FormData(form);
      const phoneCountry = formData.get('phoneCountry') as string;
      const phoneNumber = formData.get('phoneNumber') as string;
      const phone = phoneNumber ? `${phoneCountry} ${phoneNumber}` : '';

      const data = {
        email: formData.get('email') as string,
        password: formData.get('password') as string,
        confirmPassword: formData.get('confirmPassword') as string,
        firstName: formData.get('firstName') as string,
        lastName: formData.get('lastName') as string,
        phone: phone,
      };

      // Validate password match
      if (data.password !== data.confirmPassword) {
        if (errorMessage) {
          errorMessage.textContent = 'Passwords do not match';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';

      try {
        const response = await fetch('/.netlify/functions/member-register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Show success message
          if (successMessage) {
            successMessage.innerHTML = `
              <p class="font-semibold mb-2">Registration successful!</p>
              <p>${result.message}</p>
              <p class="mt-2">You will receive an email when your account is approved.</p>
            `;
            successMessage.classList.remove('hidden');
          }

          // Reset form
          form.reset();

          // Redirect to login after 3 seconds
          setTimeout(() => {
            window.location.href = '/login';
          }, 3000);
        } else {
          // Show error message
          if (errorMessage) {
            errorMessage.textContent = result.error || 'Registration failed. Please try again.';
            errorMessage.classList.remove('hidden');
          }

          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Register';
        }
      } catch (error) {
        console.error('Registration error:', error);
        if (errorMessage) {
          errorMessage.textContent = 'An error occurred. Please try again.';
          errorMessage.classList.remove('hidden');
        }

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register';
      }
    });
  </script>
</Layout>
